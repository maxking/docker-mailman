version: '2'

defaults: &defaults
  docker:
    - image: circleci/python:3

jobs:
  build:
    <<: *defaults
    steps:
        - checkout
        - setup_remote_docker
        - run:
            name: Install Docker Compose
            command: sudo pip install docker-compose
        - run:
            name: Building Container Images
            command: ./build.sh
  test:
    <<: *defaults
    steps:
      - run:
          name: Generate Tests
          command: sh tests/generate_tests.sh
      - run:
          environment:
            DB: postgres
          name: Postgres Tests
          command: sh tests/test.sh
  deploy:
    <<: *defaults
    steps:
      - run:
          name: Build and push Images
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ];
              then sh. travis/deploy_dockerhub.sh
            fi

workflows:
  version: 2
  build-test-and-deploy:
    - build
    - test:
        requires:
          - build
    - deploy:
        requires:
          - test
        
    
